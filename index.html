<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sankey Diagram of New Nodule Progression</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            background-color: #ffffff;
            color: #333333;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        .chart-container-relative {
            position: relative;
            padding-top: 40px; /* Make space for top labels */
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .controls button {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: bold;
            color: #fff;
            background-color: #555;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .controls button.active, .controls button:hover {
            background-color: #007bff;
        }
        .chart-subtitle {
            position: absolute;
            top: 0;
            font-weight: bold;
            font-size: 1.2rem; /* Increased font size */
            color: #333;
        }
        .top-left { left: 15px; }
        .top-right { right: 15px; }
        .chart-title {
            font-size: 1.75rem; /* Increased font size */
            font-weight: 600;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .main-title {
            font-size: 2.5rem; /* Increased font size */
            font-weight: bold;
            text-align: center;
            margin-bottom: 3rem;
        }
    </style>
</head>
<body class="bg-white text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header>
            <h1 class="main-title">4ITLR New Nodule Cohort Progression Analysis</h1>
        </header>

        <main class="space-y-16">
            <!-- Annual New Nodules Chart -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-lg">
                <h2 class="chart-title">Annual New Nodules (n=319)</h2>
                <div id="controls_annual" class="controls">
                    <button data-sort="risk_high_low">Sort by Risk (High to Low)</button>
                    <button data-sort="risk_low_high" class="active">Sort by Risk (Low to High)</button>
                    <button data-sort="auto">Automatic Layout</button>
                </div>
                <div id="sankey_annual_container" class="chart-container-relative">
                    <div class="chart-subtitle top-left">Annual results</div>
                    <div id="sankey_annual" style="height: 500px;"></div>
                    <div class="chart-subtitle top-right">Follow-up status</div>
                </div>
            </div>

            <!-- Baseline Repeat New Nodules Chart -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-lg">
                <h2 class="chart-title">Baseline Repeat New Nodules (n=200)</h2>
                 <div id="controls_baseline" class="controls">
                    <button data-sort="risk_high_low">Sort by Risk (High to Low)</button>
                    <button data-sort="risk_low_high" class="active">Sort by Risk (Low to High)</button>
                    <button data-sort="auto">Automatic Layout</button>
                </div>
                <div id="sankey_baseline_container" class="chart-container-relative">
                    <div class="chart-subtitle top-left">Baseline results</div>
                    <div id="sankey_baseline" style="height: 500px;"></div>
                    <div class="chart-subtitle top-right">Follow-up status</div>
                </div>
            </div>
        </main>
    </div>

    <script type="text/javascript">
        google.charts.load('current', { 'packages': ['sankey'] });
        google.charts.setOnLoadCallback(initialize);

        let annualChartData, baselineChartData;

        function initialize() {
            annualChartData = prepareChartData(
                [['Positive', 'No Follow-up', 19], ['Indeterminate', 'Positive', 16], ['Indeterminate', 'Indeterminate', 23], ['Indeterminate', 'Negative', 157], ['Indeterminate', 'No Follow-up', 72], ['Negative', 'Negative', 9], ['Negative', 'No Follow-up', 23]],
                319, { 'Positive': 19, 'Indeterminate': 268, 'Negative': 32 }, { 'Positive': 16, 'Indeterminate': 23, 'Negative': 166, 'No Follow-up': 114 }
            );
            baselineChartData = prepareChartData(
                [['Positive', 'Negative', 1], ['Positive', 'No Follow-up', 20], ['Indeterminate', 'Positive', 12], ['Indeterminate', 'Indeterminate', 9], ['Indeterminate', 'Negative', 63], ['Indeterminate', 'No Follow-up', 11], ['Negative', 'Positive', 3], ['Negative', 'Indeterminate', 11], ['Negative', 'Negative', 40], ['Negative', 'No Follow-up', 30]],
                200, { 'Positive': 21, 'Indeterminate': 95, 'Negative': 84 }, { 'Positive': 15, 'Indeterminate': 20, 'Negative': 104, 'No Follow-up': 61 }
            );
            drawCharts();
            setupControls('annual', drawAnnualChart);
            setupControls('baseline', drawBaselineRepeatChart);
        }

        function setupControls(chartName, drawFunction) {
            const controls = document.getElementById(`controls_${chartName}`);
            controls.addEventListener('click', function(event) {
                if (event.target.tagName === 'BUTTON') {
                    controls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    event.target.classList.add('active');
                    drawFunction();
                }
            });
        }

        function drawCharts() {
            drawAnnualChart();
            drawBaselineRepeatChart();
        }

        const colorPalette = { positive: '#d9534f', indeterminate: '#f0ad4e', negative: '#5cb85c', noFu: '#777777' };

        function prepareChartData(dataRowsRaw, total, initialTotals, fuTotals) {
             return { raw: dataRowsRaw, total, initialTotals, fuTotals };
        }

        function getSortOrder(sortType) {
            if (sortType === 'risk_high_low') return ['Positive', 'Indeterminate', 'Negative', 'No Follow-up'];
            return ['Negative', 'Indeterminate', 'Positive', 'No Follow-up'];
        }

        function drawSankeyChart(containerId, chartData, sortType) {
            const { raw: dataRowsRaw, total, initialTotals, fuTotals } = chartData;

            const baseSourceOrder = getSortOrder(sortType).filter(name => initialTotals[name] !== undefined);
            const baseTargetOrder = getSortOrder(sortType).filter(name => fuTotals[name] !== undefined);

            const sourceLabels = baseSourceOrder.reduce((acc, name) => {
                acc[name] = `${name}\n(n=${initialTotals[name]}, ${Math.round(initialTotals[name]/total*100)}%)`;
                return acc;
            }, {});
            const targetLabels = baseTargetOrder.reduce((acc, name) => {
                acc[name] = `${name}\n(n=${fuTotals[name]}, ${Math.round(fuTotals[name]/total*100)}%)`;
                return acc;
            }, {});
            
            const sourceTotalsForPercent = {};
            dataRowsRaw.forEach(row => {
                const sourceName = row[0];
                const count = row[2];
                if (!sourceTotalsForPercent[sourceName]) sourceTotalsForPercent[sourceName] = 0;
                sourceTotalsForPercent[sourceName] += count;
            });

            let labeledDataRows = dataRowsRaw.map(row => {
                const [sourceName, targetName, count] = row;
                const sourceTotal = sourceTotalsForPercent[sourceName];
                const percentage = ((count / sourceTotal) * 100).toFixed(0);
                const tooltipText = `n=${count}, ${percentage}%`;
                return [sourceLabels[sourceName], targetLabels[targetName], count, tooltipText];
            });

            const data = new google.visualization.DataTable();
            data.addColumn('string', 'From');
            data.addColumn('string', 'To');
            data.addColumn('number', 'Count');
            data.addColumn({type: 'string', role: 'tooltip'});
            data.addRows(labeledDataRows);
            
            const discoveredNodes = [];
            const seenNodes = new Set();
            labeledDataRows.forEach(row => {
                if (!seenNodes.has(row[0])) { discoveredNodes.push(row[0]); seenNodes.add(row[0]); }
                if (!seenNodes.has(row[1])) { discoveredNodes.push(row[1]); seenNodes.add(row[1]); }
            });

            const colorMap = {};
            discoveredNodes.forEach(nodeName => {
                const cleanName = nodeName.split('\n')[0].toLowerCase();
                if (cleanName === 'positive') colorMap[nodeName] = colorPalette.positive;
                else if (cleanName === 'indeterminate') colorMap[nodeName] = colorPalette.indeterminate;
                else if (cleanName === 'negative') colorMap[nodeName] = colorPalette.negative;
                else if (cleanName.startsWith('no')) colorMap[nodeName] = colorPalette.noFu;
            });
            const colors = discoveredNodes.map(node => colorMap[node]);

            const options = {
                height: 500,
                tooltip: { isHtml: false, textStyle: { fontName: 'Arial', fontSize: 16 } }, // Increased font size
                sankey: {
                    node: {
                        label: { fontName: 'Arial', fontSize: 16, color: '#333333', bold: true }, // Increased font size
                        labelPadding: 10,
                        nodePadding: 20,
                        width: 30,
                        colors: colors,
                    },
                    link: { colorMode: 'gradient', colors: colors },
                    iterations: sortType === 'auto' ? 32 : 0
                }
            };

            const chart = new google.visualization.Sankey(document.getElementById(containerId));
            chart.draw(data, options);
        }

        function drawAnnualChart() {
            const sortType = document.querySelector('#controls_annual .active').dataset.sort;
            drawSankeyChart('sankey_annual', annualChartData, sortType);
        }

        function drawBaselineRepeatChart() {
            const sortType = document.querySelector('#controls_baseline .active').dataset.sort;
            drawSankeyChart('sankey_baseline', baselineChartData, sortType);
        }
    </script>

</body>
</html>

