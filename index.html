<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sankey Diagram of New Nodule Progression</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            background-color: #ffffff;
            color: #333333;
        }
        .container {
            max-width: 1280px; 
            margin: 0 auto;
        }
        .chart-container-relative {
            position: relative;
            padding-top: 40px; 
        }
        .chart-subtitle {
            position: absolute;
            top: 0;
            font-weight: bold;
            font-size: 1.2rem;
            color: #333;
        }
        .top-left { left: 15px; }
        .top-right { right: 15px; }
        .chart-title {
            font-size: 1.75rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .main-title {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 3rem;
        }
        .footnote {
            text-align: center;
            margin-top: 1rem;
            font-style: italic;
            color: #666;
        }
    </style>
</head>
<body class="bg-white text-gray-800">

    <div class="container mx-auto p-6 md:p-12">
        <header>
            <h1 class="main-title">4ITLR New Nodule Cohort Progression Analysis</h1>
        </header>

        <main class="space-y-16">
            <!-- Annual New Nodules Chart -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-lg">
                <h2 class="chart-title">4ITLR Annual New Nodules (n=319)</h2>
                <div id="sankey_annual_container" class="chart-container-relative">
                    <div class="chart-subtitle top-left">Annual results</div>
                    <div id="sankey_annual" style="height: 600px;"></div>
                    <div class="chart-subtitle top-right">Final Follow-up status</div>
                </div>
                <p class="footnote">
                    *Note: For cases that remained 'Indeterminate' after the first follow-up, this diagram shows their final status after the second follow-up.
                </p>
            </div>

            <!-- Baseline Repeat New Nodules Chart -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-lg">
                <h2 class="chart-title">4ITLR Baseline Repeat New Nodules (n=200)</h2>
                <div id="sankey_baseline_container" class="chart-container-relative">
                    <div class="chart-subtitle top-left">Baseline repeat results</div>
                    <div id="sankey_baseline" style="height: 600px;"></div>
                    <div class="chart-subtitle top-right">Final Follow-up status</div>
                </div>
                 <p class="footnote">
                    *Note: For cases that remained 'Indeterminate' after the first follow-up, this diagram shows their final status after the second follow-up.
                </p>
            </div>
        </main>
    </div>

    <script type="text/javascript">
        google.charts.load('current', { 'packages': ['sankey'] });
        google.charts.setOnLoadCallback(initialize);

        function initialize() {
            drawAnnualChart();
            drawBaselineRepeatChart();
        }

        const colorPalette = { positive: '#d9534f', indeterminate: '#f0ad4e', negative: '#5cb85c', noFu: '#777777' };

        function drawSankeyChart(containerId, chartData) {
            const { total, initialTotals, finalTotals, dataRows, initialOrder, finalOrder } = chartData;

            const data = new google.visualization.DataTable();
            data.addColumn('string', 'From');
            data.addColumn('string', 'To');
            data.addColumn('number', 'Count');
            data.addColumn({type: 'string', role: 'tooltip'});

            const nodes = {
                initial: {
                    Negative: `Negative\n(n=${initialTotals.neg}, ${Math.round(initialTotals.neg/total*100)}%)`,
                    Indeterminate: `Indeterminate\n(n=${initialTotals.ind}, ${Math.round(initialTotals.ind/total*100)}%)`,
                    Positive: `Positive\n(n=${initialTotals.pos}, ${Math.round(initialTotals.pos/total*100)}%)`
                },
                final: {
                    Negative: `Negative\n(n=${finalTotals.neg}, ${Math.round(finalTotals.neg/total*100)}%)`,
                    Positive: `Positive\n(n=${finalTotals.pos}, ${Math.round(finalTotals.pos/total*100)}%)`,
                    "No follow-up yet": `No follow-up yet\n(n=${finalTotals.noFu}, ${Math.round(finalTotals.noFu/total*100)}%)`
                }
            };
            
            const sourceTotalsForPercent = {
                [nodes.initial.Negative]: initialTotals.neg,
                [nodes.initial.Indeterminate]: initialTotals.ind,
                [nodes.initial.Positive]: initialTotals.pos
            };

            let labeledDataRows = dataRows.map(row => {
                const [fromKey, toKey, count] = row;
                const fromNode = nodes.initial[fromKey];
                const toNode = nodes.final[toKey];
                const sourceTotal = sourceTotalsForPercent[fromNode];
                const percentage = sourceTotal > 0 ? ((count / sourceTotal) * 100).toFixed(0) : 0;
                const tooltipText = `n=${count}, ${percentage}%`;
                return [fromNode, toNode, count, tooltipText];
            });

            // Enforce strict sorting
            labeledDataRows.sort((a,b) => {
                const fromNodeA = a[0];
                const fromNodeB = b[0];
                const toNodeA = a[1];
                const toNodeB = b[1];

                const fromOrder = initialOrder.map(key => nodes.initial[key]);
                const toOrder = finalOrder.map(key => nodes.final[key]);

                const fromIndexA = fromOrder.indexOf(fromNodeA);
                const fromIndexB = fromOrder.indexOf(fromNodeB);
                if(fromIndexA !== fromIndexB) return fromIndexA - fromIndexB;

                const toIndexA = toOrder.indexOf(toNodeA);
                const toIndexB = toOrder.indexOf(toNodeB);
                return toIndexA - toIndexB;
            });

            data.addRows(labeledDataRows);

            const discoveredNodes = [];
            const seenNodes = new Set();
            labeledDataRows.forEach(row => {
                if (!seenNodes.has(row[0])) { discoveredNodes.push(row[0]); seenNodes.add(row[0]); }
                if (!seenNodes.has(row[1])) { discoveredNodes.push(row[1]); seenNodes.add(row[1]); }
            });

            const colorMap = {};
            discoveredNodes.forEach(nodeName => {
                const cleanName = nodeName.split('\n')[0].toLowerCase();
                if (cleanName.includes('positive')) colorMap[nodeName] = colorPalette.positive;
                else if (cleanName.includes('indeterminate')) colorMap[nodeName] = colorPalette.indeterminate;
                else if (cleanName.includes('negative')) colorMap[nodeName] = colorPalette.negative;
                else if (cleanName.includes('no')) colorMap[nodeName] = colorPalette.noFu;
            });
            const colors = discoveredNodes.map(node => colorMap[node]);

            const options = {
                height: 600,
                tooltip: { isHtml: false, textStyle: { fontName: 'Arial', fontSize: 16 } },
                sankey: {
                    node: {
                        label: { fontName: 'Arial', fontSize: 16, color: '#333333', bold: true },
                        labelPadding: 10,
                        nodePadding: 15,
                        width: 30,
                        colors: colors,
                    },
                    link: { colorMode: 'gradient', colors: colors },
                    iterations: 0
                }
            };
            const chart = new google.visualization.Sankey(document.getElementById(containerId));
            chart.draw(data, options);
        }

        function drawAnnualChart() {
            const total = 319;
            const initialTotals = { neg: 32, ind: 268, pos: 19 };
            const finalTotals = { neg: 176, pos: 39, noFu: 104 };
            const initialOrder = ['Negative', 'Indeterminate', 'Positive'];
            const finalOrder = ['Negative', 'No follow-up yet', 'Positive'];
            
            const dataRows = [
                ['Negative', 'Negative', 9],
                ['Negative', 'No follow-up yet', 23],
                ['Indeterminate', 'Negative', 167],
                ['Indeterminate', 'Positive', 20],
                ['Indeterminate', 'No follow-up yet', 81],
                ['Positive', 'Positive', 19]
            ];
            
            drawSankeyChart('sankey_annual', { total, initialTotals, finalTotals, dataRows, initialOrder, finalOrder });
        }

        function drawBaselineRepeatChart() {
             const total = 200;
            const initialTotals = { neg: 84, ind: 95, pos: 21 };
            const finalTotals = { neg: 117, pos: 36, noFu: 47 };
            const initialOrder = ['Negative', 'Indeterminate', 'Positive'];
            const finalOrder = ['Negative', 'No follow-up yet', 'Positive'];
            
            const dataRows = [
                ['Negative', 'Negative', 46],
                ['Negative', 'Positive', 3],
                ['Negative', 'No follow-up yet', 35],
                ['Indeterminate', 'Negative', 70],
                ['Indeterminate', 'Positive', 13],
                ['Indeterminate', 'No follow-up yet', 12],
                ['Positive', 'Negative', 1],
                ['Positive', 'Positive', 20]
            ];
            
            drawSankeyChart('sankey_baseline', { total, initialTotals, finalTotals, dataRows, initialOrder, finalOrder });
        }
    </script>

</body>
</html>

